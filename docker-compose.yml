version: '3.8'

# ═══════════════════════════════════════════════════════════════════════════════
# LUVEX.TECH - Production WordPress Stack
# ═══════════════════════════════════════════════════════════════════════════════
# Architecture: Nginx (Reverse Proxy) → WordPress (PHP-FPM) → MySQL
# Network: Isolated luvex-network (completely separate from Lunaria)
# ═══════════════════════════════════════════════════════════════════════════════

services:
  # ═══════════════════════════════════════════════════════════════════════════════
  # MySQL 8.0 - Database Server
  # ═══════════════════════════════════════════════════════════════════════════════
  mysql:
    image: mysql:8.0
    container_name: luvex-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./backups:/backups
    networks:
      luvex-network:
        # Internal WordPress network
      db-shared:
        # Shared network for external app access
        aliases:
          - wp-db
    command:
      - '--default-authentication-plugin=mysql_native_password'
      - '--character-set-server=utf8mb4'
      - '--collation-server=utf8mb4_unicode_ci'
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ═══════════════════════════════════════════════════════════════════════════════
  # WordPress 6.x with PHP 8.2 FPM
  # ═══════════════════════════════════════════════════════════════════════════════
  wordpress:
    image: wordpress:6.4-php8.2-fpm-alpine
    container_name: luvex-wordpress
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      WORDPRESS_DB_HOST: mysql:3306
      WORDPRESS_DB_NAME: ${MYSQL_DATABASE}
      WORDPRESS_DB_USER: ${MYSQL_USER}
      WORDPRESS_DB_PASSWORD: ${MYSQL_PASSWORD}
      WORDPRESS_TABLE_PREFIX: ${WORDPRESS_TABLE_PREFIX:-wp_}
      WORDPRESS_DEBUG: ${WORDPRESS_DEBUG:-false}
      WORDPRESS_CONFIG_EXTRA: |
        define('WP_MEMORY_LIMIT', '256M');
        define('WP_MAX_MEMORY_LIMIT', '512M');
        define('FORCE_SSL_ADMIN', true);
        if (isset($$_SERVER['HTTP_X_FORWARDED_PROTO']) && $$_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https') {
          $$_SERVER['HTTPS'] = 'on';
        }
    volumes:
      # WordPress Core
      - wordpress_data:/var/www/html
      # Custom Theme (this repository)
      - ./:/var/www/html/wp-content/themes/luvex:ro
      # Uploads & Plugins (persistent)
      - wordpress_uploads:/var/www/html/wp-content/uploads
      - wordpress_plugins:/var/www/html/wp-content/plugins
    networks:
      - luvex-network
    healthcheck:
      test: ["CMD-SHELL", "php-fpm-healthcheck || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ═══════════════════════════════════════════════════════════════════════════════
  # Nginx - Reverse Proxy & SSL Termination
  # ═══════════════════════════════════════════════════════════════════════════════
  nginx:
    image: nginx:alpine
    container_name: luvex-nginx
    restart: unless-stopped
    depends_on:
      - wordpress
    volumes:
      - ./nginx/luvex.conf:/etc/nginx/conf.d/default.conf:ro
      - wordpress_data:/var/www/html:ro
      - wordpress_uploads:/var/www/html/wp-content/uploads:ro
      - ./:/var/www/html/wp-content/themes/luvex:ro
      # SSL Certificates (Let's Encrypt)
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /var/www/certbot:/var/www/certbot:ro
    networks:
      - luvex-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.luvex.rule=Host(`luvex.tech`) || Host(`www.luvex.tech`)"
      - "traefik.http.routers.luvex.entrypoints=websecure"
      - "traefik.http.routers.luvex.tls=true"
      - "traefik.http.routers.luvex.tls.certresolver=letsencrypt"
      - "traefik.http.routers.luvex.service=luvex"
      - "traefik.http.services.luvex.loadbalancer.server.port=80"
      - "traefik.http.routers.luvex.middlewares=compression@file"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/nginx-health"]
      interval: 30s
      timeout: 10s
      retries: 3

# ═══════════════════════════════════════════════════════════════════════════════
# DOCKER VOLUMES - Persistent Data Storage
# ═══════════════════════════════════════════════════════════════════════════════
volumes:
  mysql_data:
  wordpress_data:
  wordpress_uploads:
  wordpress_plugins:

# ═══════════════════════════════════════════════════════════════════════════════
# DOCKER NETWORKS
# ═══════════════════════════════════════════════════════════════════════════════
networks:
  luvex-network:
    external: true
    name: luvex-network
  db-shared:
    external: true
    name: db-shared
